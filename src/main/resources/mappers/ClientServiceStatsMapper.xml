<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.panjy.servicemetricsplatform.mapper.ClientServiceStatsMapper">

    <!-- ClientServiceStats Result Map -->
    <resultMap id="ClientServiceStatsResultMap" type="org.panjy.servicemetricsplatform.entity.ClientServiceStats">
        <result column="colCltID" property="colCltID"/>
        <result column="emp_list" property="empList" typeHandler="org.panjy.servicemetricsplatform.util.StringArrayTypeHandler"/>
        <result column="emp_count" property="empCount"/>
        <result column="service_seconds" property="serviceSeconds"/>
        <result column="service_days" property="serviceDays"/>
    </resultMap>

    <!-- 查询满足条件的客户服务统计数据 -->
    <select id="getClientServiceStats" resultMap="ClientServiceStatsResultMap">
        SELECT 
            o.colCltID,
            groupArray(DISTINCT o.colEmpID) AS emp_list,
            countDistinct(o.colEmpID) AS emp_count,
            max(s.colSerTi) AS service_seconds,
            round(max(s.colSerTi) / 86400, 2) AS service_days
        FROM aikang.tbl_Order AS o
        INNER JOIN aikang.tbl_ServerTime AS s
            ON o.colCltID = s.colCltID
        WHERE s.colSerTi > 864000
        GROUP BY o.colCltID
        HAVING emp_count >= 3
        ORDER BY service_days DESC
    </select>

</mapper>