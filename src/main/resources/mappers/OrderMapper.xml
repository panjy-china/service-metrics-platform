<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.panjy.servicemetricsplatform.mapper.OrderMapper">

    <!-- 查询指定日期的日下单用户数 -->
    <select id="getDailyOrderingUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT o.colCltID) AS user_count
        FROM aikang.tbl_Order o
        INNER JOIN aikang.tbl_server_account a
            ON o.colEmpID = a.account_code
        WHERE toDate(o.colOdrTim) = toDate(#{date})
    </select>

    <!-- 查询指定日期前一天的日下单用户数 -->
    <select id="getPreviousDayOrderingUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT o.colCltID) AS user_count
        FROM aikang.tbl_Order o
        INNER JOIN aikang.tbl_server_account a
            ON o.colEmpID = a.account_code
        WHERE toDate(o.colOdrTim) = toDate(#{date}) - INTERVAL 1 DAY
    </select>

    <!-- 查询指定日期所在周的下单用户数 -->
    <select id="getWeeklyOrderingUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT o.colCltID) AS user_count
        FROM aikang.tbl_Order o
        INNER JOIN aikang.tbl_server_account a
            ON o.colEmpID = a.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfWeek(toDate(#{date}))
          AND toDate(o.colOdrTim) &lt; addWeeks(toStartOfWeek(toDate(#{date})), 1)
    </select>

    <!-- 查询指定日期前一周的下单用户数 -->
    <select id="getPreviousWeekOrderingUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT o.colCltID) AS user_count
        FROM aikang.tbl_Order o
        INNER JOIN aikang.tbl_server_account a
            ON o.colEmpID = a.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfWeek(toDate(#{date}) - INTERVAL 7 DAY)
          AND toDate(o.colOdrTim) &lt; addWeeks(toStartOfWeek(toDate(#{date}) - INTERVAL 7 DAY), 1)
    </select>

    <!-- 查询指定日期所在月的下单用户数 -->
    <select id="getMonthlyOrderingUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT o.colCltID) AS user_count
        FROM aikang.tbl_Order o
        INNER JOIN aikang.tbl_server_account a
            ON o.colEmpID = a.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfMonth(toDate(#{date}))
          AND toDate(o.colOdrTim) &lt; addMonths(toStartOfMonth(toDate(#{date})), 1)
    </select>

    <!-- 查询指定日期前一个月的下单用户数 -->
    <select id="getPreviousMonthOrderingUsers" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT o.colCltID) AS user_count
        FROM aikang.tbl_Order o
        INNER JOIN aikang.tbl_server_account a
            ON o.colEmpID = a.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfMonth(toDate(#{date}) - INTERVAL 1 MONTH)
          AND toDate(o.colOdrTim) &lt; addMonths(toStartOfMonth(toDate(#{date}) - INTERVAL 1 MONTH), 1)
    </select>

    <!-- 查询指定日期的日销售总额 -->
    <select id="getDailySalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
        JOIN aikang.tbl_server_account sa ON o.colEmpID = sa.account_code
        WHERE toDate(o.colOdrTim) = toDate(#{date})
        AND o.colTotal > 0
    </select>
    
    <!-- 查询指定日期前一天的日销售总额 -->
    <select id="getPreviousDaySalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
        JOIN aikang.tbl_server_account sa ON o.colEmpID = sa.account_code
        WHERE toDate(o.colOdrTim) = toDate(#{date}) - INTERVAL 1 DAY
        AND o.colTotal > 0
    </select>

    <!-- 查询指定日期所在自然周的销售总额 -->
    <select id="getWeeklySalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
        JOIN aikang.tbl_server_account sa ON o.colEmpID = sa.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfWeek(toDate(#{date}))
        AND toDate(o.colOdrTim) &lt; addWeeks(toStartOfWeek(toDate(#{date})), 1)
        AND o.colTotal > 0
    </select>
    
    <!-- 查询指定日期前一周的销售总额 -->
    <select id="getPreviousWeeklySalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
        JOIN aikang.tbl_server_account sa ON o.colEmpID = sa.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfWeek(toDate(#{date}) - INTERVAL 7 DAY)
        AND toDate(o.colOdrTim) &lt; addWeeks(toStartOfWeek(toDate(#{date}) - INTERVAL 7 DAY), 1)
        AND o.colTotal > 0
    </select>

    <!-- 查询指定日期所在自然月的销售总额 -->
    <select id="getMonthlySalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
        JOIN aikang.tbl_server_account sa ON o.colEmpID = sa.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfMonth(toDate(#{date}))
        AND toDate(o.colOdrTim) &lt; addMonths(toStartOfMonth(toDate(#{date})), 1)
        AND o.colTotal > 0
    </select>
    
    <!-- 查询指定日期前一个月的销售总额 -->
    <select id="getPreviousMonthlySalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
        JOIN aikang.tbl_server_account sa ON o.colEmpID = sa.account_code
        WHERE toDate(o.colOdrTim) >= toStartOfMonth(toDate(#{date}) - INTERVAL 1 MONTH)
        AND toDate(o.colOdrTim) &lt; addMonths(toStartOfMonth(toDate(#{date}) - INTERVAL 1 MONTH), 1)
        AND o.colTotal > 0
    </select>

    <!-- Get total sales amount for specified time period -->
    <select id="getTotalSalesAmount" resultType="java.math.BigDecimal">
        SELECT SUM(colTotal) as totalAmount
        FROM aikang.tbl_Order o
                 JOIN aikang.tbl_server_account sa
                      ON o.colEmpID = sa.account_code
        WHERE o.colOdrTim >= #{startTime}
          AND o.colOdrTim &lt;= #{endTime}
          AND o.colTotal > 0
    </select>

    <!-- Get total customer count for specified time period -->
    <select id="getTotalCustomerCount" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT colCltID) as customerCount
        FROM aikang.tbl_Order
        WHERE colOdrTim >= #{startTime}
        AND colOdrTim &lt;= #{endTime}
        AND colTotal > 0
    </select>

    <!-- Get total order count for specified time period -->
    <select id="getTotalOrderCount" resultType="java.lang.Long">
        SELECT COUNT(*) AS orderCount
        FROM aikang.tbl_Order o
                 JOIN aikang.tbl_server_account sa
                      ON o.colEmpID = sa.account_code
        WHERE o.colOdrTim <![CDATA[ >= ]]> #{startTime}
          AND o.colOdrTim <![CDATA[ <= ]]> #{endTime}
          AND o.colTotal > 0
    </select>
    
    <!-- Get earliest order time for specified client -->
    <select id="getEarliestOrderTimeByClientId" resultType="java.time.LocalDateTime">
        SELECT MIN(colOdrTim) as earliestTime
        FROM aikang.tbl_Order
        WHERE colCltID = #{clientId}
    </select>
    
    <!-- Get latest order time for specified client -->
    <select id="getLatestOrderTimeByClientId" resultType="java.time.LocalDateTime">
        SELECT MAX(colOdrTim) as latestTime
        FROM aikang.tbl_Order
        WHERE colCltID = #{clientId}
    </select>
    
    <!-- Get earliest order time for all clients -->
    <select id="getEarliestOrderTimeForAll" resultType="java.time.LocalDateTime">
        SELECT MIN(colOdrTim) as earliestTime
        FROM aikang.tbl_Order
    </select>
    
    <!-- Get latest order time for all clients -->
    <select id="getLatestOrderTimeForAll" resultType="java.time.LocalDateTime">
        SELECT MAX(colOdrTim) as latestTime
        FROM aikang.tbl_Order
    </select>
    
    <!-- Get all unique client IDs -->
    <select id="getAllUniqueClientIds" resultType="java.lang.String">
        SELECT DISTINCT colCltID
        FROM aikang.tbl_Order
        WHERE colCltID IS NOT NULL AND colCltID != ''
    </select>
    
    <!-- Get new client IDs after specified date -->
    <select id="getNewClientIdsAfterDate" resultType="java.lang.String">
        SELECT colCltID
        FROM (
            SELECT colCltID, MIN(colOdrTim) as firstOrderTime
            FROM aikang.tbl_Order
            WHERE colCltID IS NOT NULL AND colCltID != ''
            GROUP BY colCltID
        ) t
        WHERE firstOrderTime &gt;= #{date}
    </select>
    
    <!-- 根据处理后的地址串进行模糊查询，返回匹配到的第一条记录的客户ID -->
    <select id="getCltIdByProcessedAddress" resultType="java.lang.String">
        SELECT colCltID
        FROM aikang.tbl_Order
        WHERE colAddress LIKE CONCAT('%', #{processedAddress}, '%')
        LIMIT 1
    </select>

</mapper>