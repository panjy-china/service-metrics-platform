# 服务指标平台部署文档

## 1. 系统概述

服务指标平台是一个基于Spring Boot开发的数据分析平台，主要用于分析和展示微信服务指标数据。系统通过大模型分析用户数据，提供客户信息分析、地址分布、数据看板等功能。

## 2. 系统架构

- **开发语言**: Java 21
- **框架**: Spring Boot 3.1.2
- **数据库**: ClickHouse
- **数据访问**: MyBatis
- **部署方式**: Docker + Docker Compose
- **构建工具**: Maven

## 3. 环境要求

### 3.1 硬件要求
- **CPU**: 至少2核
- **内存**: 至少4GB RAM（推荐8GB）
- **存储**: 至少10GB可用空间
- **网络**: 稳定的互联网连接（用于大模型API调用）

### 3.2 软件要求
- **操作系统**: Linux、Windows或macOS
- **Docker**: 版本20.10.0及以上
- **Docker Compose**: 版本2.0.0及以上
- **JDK**: Java 21（开发环境）

## 4. 部署方式

### 4.1 Docker Compose 部署（推荐）

#### 4.1.1 环境准备
1. 安装Docker和Docker Compose
2. 确保Docker服务正在运行

#### 4.1.2 部署步骤

1. **克隆项目代码**
```bash
git clone <repository-url>
cd service-metrics-platform
```

2. **构建并启动服务**
```bash
docker-compose up -d
```

3. **检查服务状态**
```bash
docker-compose ps
```

4. **查看日志**
```bash
docker-compose logs -f service-metrics-platform
```

#### 4.1.3 配置说明

在 `docker-compose.yml` 文件中，主要配置项包括：

- **端口映射**: `9712:9712`
- **环境变量**:
  - `SPRING_PROFILES_ACTIVE`: 指定Spring配置文件环境
  - `SERVER_PORT`: 服务端口
  - `CLICKHOUSE_URL`: ClickHouse数据库连接地址
  - `CLICKHOUSE_USERNAME`: ClickHouse用户名
  - `CLICKHOUSE_PASSWORD`: ClickHouse密码
  - `DASHSCOPE_API_KEY`: 大模型API密钥
  - `JAVA_OPTS`: JVM参数配置

#### 4.1.4 服务访问

- **应用访问地址**: `http://localhost:9712`
- **健康检查地址**: `http://localhost:9712/api/order-metrics/health`

### 4.2 传统JAR包部署

#### 4.2.1 构建JAR包
```bash
# 编译打包
mvn clean package -DskipTests

# JAR包位置
target/service-metrics-platform-0.0.1-SNAPSHOT.jar
```

#### 4.2.2 启动应用
```bash
# 直接运行
java -jar target/service-metrics-platform-0.0.1-SNAPSHOT.jar

# 或配置JVM参数运行
java -Xms512m -Xmx1024m -XX:+UseG1GC -jar target/service-metrics-platform-0.0.1-SNAPSHOT.jar
```

#### 4.2.3 配置文件修改

修改 `application.yml` 中的数据库连接信息：

```yaml
spring:
  datasource:
    url: jdbc:clickhouse://<your-clickhouse-host>:8123/aikang?compress=0&http_connection_provider=HTTP_URL_CONNECTION
    username: <your-username>
    password: <your-password>
    driver-class-name: com.clickhouse.jdbc.ClickHouseDriver

dashscope:
  apiKey: "<your-api-key>"
```

## 5. 配置说明

### 5.1 数据库配置

系统使用ClickHouse作为数据存储，主要配置项在 `application.yml` 中：

```yaml
spring:
  datasource:
    url: jdbc:clickhouse://106.14.221.209:8123/aikang?compress=0&http_connection_provider=HTTP_URL_CONNECTION
    username: default
    password: 123456
    driver-class-name: com.clickhouse.jdbc.ClickHouseDriver
```

### 5.2 大模型API配置

系统使用DashScope API进行数据智能分析：

```yaml
dashscope:
  apiKey: "sk-4d14608f5c5d40eb926fcd2f44258e20"
```

### 5.3 JVM配置

在Docker环境中，JVM参数通过环境变量配置：

```bash
JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseContainerSupport -Djava.security.egd=file:/dev/./urandom"
```

## 6. Docker镜像说明

项目提供多种Docker镜像配置：

### 6.1 标准镜像 (Dockerfile)
- 基于Alpine Linux
- 使用OpenJDK 21
- 包含完整的应用依赖

### 6.2 快速构建镜像 (Dockerfile.fast)
- 优化构建时间
- 适合开发和测试环境

### 6.3 最小化镜像 (Dockerfile.minimal)
- 最小化镜像大小
- 适合生产环境部署

## 7. 日志管理

### 7.1 日志配置

应用使用SLF4J + Logback进行日志管理，配置在 `application.yml` 中：

```yaml
logging:
  level:
    root: INFO
    org.panjy.servicemetricsplatform: DEBUG
    org.springframework.web: INFO
    org.mybatis: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"
  file:
    name: logs/service-metrics-platform.log
    max-size: 50MB
    max-history: 10
    total-size-cap: 1GB
```

### 7.2 日志文件位置

- **容器内**: `/app/logs/`
- **宿主机**: 与项目目录下的 `logs` 目录映射

## 8. 健康检查

### 8.1 容器健康检查

Docker Compose配置了健康检查：

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:9712/api/order-metrics/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s
```

### 8.2 应用健康端点

- **健康检查URL**: `http://localhost:9712/api/order-metrics/health`

## 9. 性能调优

### 9.1 JVM调优

推荐的JVM参数配置：

```bash
-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseContainerSupport -Djava.security.egd=file:/dev/./urandom
```

### 9.2 数据库连接池调优

使用HikariCP连接池，主要参数在 `application.yml` 中配置。

## 10. 监控和维护

### 10.1 容器监控

使用Docker命令监控容器状态：

```bash
# 查看容器状态
docker stats service-metrics-platform

# 查看容器日志
docker logs -f service-metrics-platform
```

### 10.2 应用监控

- **端口**: 9712
- **健康检查**: 每30秒检查一次
- **日志级别**: DEBUG级别可查看详细业务日志

## 11. 故障排除

### 11.1 常见问题

1. **数据库连接失败**
   - 检查ClickHouse服务是否正常运行
   - 验证连接参数是否正确
   - 确认网络连接是否正常

2. **大模型API调用失败**
   - 检查API Key是否正确配置
   - 验证网络连接是否正常
   - 确认API服务是否可用

3. **容器启动失败**
   - 检查Docker服务是否运行
   - 验证端口是否被占用
   - 查看容器日志获取错误信息

### 11.2 日志分析

查看应用日志以定位问题：

```bash
docker-compose logs service-metrics-platform
```

## 12. 升级和维护

### 12.1 版本升级

1. 拉取最新代码
2. 重新构建Docker镜像
3. 重启服务

```bash
git pull
docker-compose build
docker-compose up -d
```

### 12.2 数据备份

定期备份ClickHouse数据库和应用日志。

## 13. 安全配置

### 13.1 API密钥管理

- 将API密钥存储在安全的位置
- 不要在代码中硬编码API密钥
- 定期轮换API密钥

### 13.2 网络安全

- 使用安全的网络连接
- 配置防火墙规则
- 定期更新系统和组件

## 14. 扩展配置

### 14.1 多环境配置

通过Spring Profiles支持多环境部署：

- **开发环境**: `dev`
- **生产环境**: `prod`

### 14.2 负载均衡

在生产环境中，可通过Nginx等反向代理实现负载均衡（当前docker-compose.yml中已注释相关配置）。